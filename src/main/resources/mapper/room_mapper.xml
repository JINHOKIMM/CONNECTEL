<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd"
>

<mapper namespace="com.connec.tel.dao.RoomDAO">
	<select id="liveRoomManageAjax" resultType="com.connec.tel.dto.RoomDTO">
		SELECT room_no,room_status,s.res_no ,s.stay_check_in 
			FROM room r LEFT JOIN stay s using(room_no);
	</select>
	
	<select id="reservationList" resultType="com.connec.tel.dto.RoomDTO">
		SELECT res_no,cos_name,cos_phone,
					cos_email,in_date,out_date,res_date,res_price
		FROM reservation WHERE Date(in_date) = CURRENT_DATE();
	</select>
	
	<select id="reservationSearchList" resultType="com.connec.tel.dto.RoomDTO" parameterType="map">
		SELECT res_no,cos_name,cos_phone,
					cos_email,in_date,out_date,res_date,res_price
		FROM reservation WHERE Date(in_date) = CURRENT_DATE() AND cos_name = #{name};	
	</select>
	
	<insert id="checkIn" parameterType="map">
		INSERT INTO stay(res_no,room_no,stay_check_in,register,regist_date)
			VALUES(#{res_no},#{room_no},#{check_in},#{emp_no},#{regist_date})
	</insert>
	
	<update id="roomCheckIn" parameterType="String">
		UPDATE room SET room_status = 'I' WHERE room_no = #{room_no} 
	</update>
	
	<select id="checkInInfo" resultType="com.connec.tel.dto.RoomDTO">
		SELECT res_no,stay_check_in  FROM stay 
			WHERE room_no = #{room_no} ORDER BY stay_check_in DESC;
	</select>
	
	<update id="checkOut" parameterType="String">
		UPDATE stay 
		SET stay_check_out = CONVERT_TZ(NOW(), 'UTC', 'Asia/Seoul'),
			   updater = #{emp_no},
			   update_date = CONVERT_TZ(NOW(), 'UTC', 'Asia/Seoul')
		WHERE room_no = #{room_no}
  		AND res_no = #{res_no}
	</update>
	
	<update id="roomCheckOut" parameterType="String">
		UPDATE room SET room_status = 'O' WHERE room_no = #{room_no} 
	</update>
	
	<select id="roomStateList" resultType="com.connec.tel.dto.RoomDTO">
		<if test="param1 == ''">
			SELECT room_no, type_code, room_status FROM room LIMIT #{param2}, #{param3}
		</if>
		
		<if test="param1 != null">
			SELECT room_no, type_code, room_status FROM room WHERE room_no LIKE #{param1} LIMIT #{param2}, #{param3}
		</if>
	</select>
	
	<update id="updateNotAvailable">
		UPDATE room SET room_status = 'N'  WHERE room_no = #{room_no}
	</update>
	
	<update id="updateAvailable">
		UPDATE room SET room_status = 'A'  WHERE room_no = #{room_no}
	</update>
	
	<select id="totalPage" resultType="int">

		<if test="param1 == ''">
			SELECT CEIL(COUNT(room_no)/#{param2}) AS pages FROM room
		</if>
	
		<if test="param1 != null">
			SELECT CEIL(COUNT(room_no)/#{param2}) AS pages FROM room WHERE room_no LIKE #{param1}
		</if>
	
	</select>
	
	
	
</mapper>